<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Nutrition Scatter Plot</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
    <h1>Nutrition Scatter Plot</h1>
    <form id="form">
        <label for="restaurant">Restaurant:</label>
        <select id="restaurant" name="restaurant"></select>
        
        <label for="category1">Nutrition Category 1:</label>
        <select id="category1" name="category1"></select>
        
        <label for="category2">Nutrition Category 2:</label>
        <select id="category2" name="category2"></select>
        
        <button type="submit">Submit</button>
    </form>
    <div id="plot"></div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // Pass data from Flask to JavaScript
            const restaurants = JSON.parse('{{ restaurants | tojson | safe }}');
            const categories = JSON.parse('{{ categories | tojson | safe }}');
            
            // Debug: Check if data is correctly parsed
            console.log("Restaurants:", restaurants);
            console.log("Categories:", categories);

            const restaurantSelect = document.getElementById('restaurant');
            const category1Select = document.getElementById('category1');
            const category2Select = document.getElementById('category2');
            
            restaurants.forEach(r => {
                const option = document.createElement('option');
                option.value = r;
                option.textContent = r;
                restaurantSelect.appendChild(option);
            });
            
            categories.forEach(c => {
                const option1 = document.createElement('option');
                const option2 = document.createElement('option');
                option1.value = c;
                option1.textContent = c;
                option2.value = c;
                option2.textContent = c;
                category1Select.appendChild(option1);
                category2Select.appendChild(option2);
            });

            // Handle form submission
            document.getElementById('form').addEventListener('submit', function(event) {
                event.preventDefault();
                
                const formData = new FormData(event.target);
                fetch('/get_data', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    // Plot the data
                    plotData(data);
                });
            });

            function plotData(data) {
                const width = 500;
                const height = 500;
                const margin = { top: 20, right: 30, bottom: 40, left: 50 };

                d3.select("#plot").html("");

                const svg = d3.select("#plot")
                    .append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                    .append("g")
                    .attr("transform", `translate(${margin.left},${margin.top})`);

                const x = d3.scaleLinear()
                    .domain(d3.extent(data, d => d[Object.keys(d)[1]]))
                    .range([0, width]);

                const y = d3.scaleLinear()
                    .domain(d3.extent(data, d => d[Object.keys(d)[2]]))
                    .range([height, 0]);

                svg.append("g")
                    .attr("transform", `translate(0,${height})`)
                    .call(d3.axisBottom(x).ticks(5));

                svg.append("g")
                    .call(d3.axisLeft(y).ticks(5));

                svg.append("g")
                    .selectAll("circle")
                    .data(data)
                    .enter()
                    .append("circle")
                    .attr("cx", d => x(d[Object.keys(d)[1]]))
                    .attr("cy", d => y(d[Object.keys(d)[2]]))
                    .attr("r", 5)
                    .style("fill", "#69b3a2");
            }
        });
    </script>
</body>
</html>